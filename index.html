<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Off-Grid Solar System Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            text-align: center;
            padding: 20px 30px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .header-content {
            flex: 1;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 0;
            min-height: 600px;
        }
        
        .left-panel {
            border-right: 2px solid #e9ecef;
        }
        
        .system-diagram {
            background: #f8f9fa;
            padding: 25px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .diagram-title {
            text-align: center;
            color: #333;
            font-size: 1.3em;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .diagram-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .component-icon {
            background: white;
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 80px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .component-icon:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            border-color: #f093fb;
        }
        
        .component-icon .icon {
            font-size: 2em;
            margin-bottom: 5px;
            transition: transform 0.3s ease;
        }
        
        .component-icon:hover .icon {
            transform: scale(1.1);
        }
        
        .component-icon .label {
            font-weight: 600;
            color: #333;
            font-size: 0.7em;
        }
        
        .flow-arrow {
            font-size: 1.5em;
            color: #667eea;
            font-weight: bold;
        }
        
        .battery-section {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        
        .status-info {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
            font-size: 0.85em;
            text-align: center;
            color: #1976d2;
        }
        
        .right-panel {
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        
        .device-panel {
            padding: 20px;
            flex: 1;
            border-bottom: 2px solid #e9ecef;
        }
        
        .device-panel h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .add-device-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 15px;
            transition: transform 0.2s ease;
            width: 100%;
        }
        
        .add-device-btn:hover {
            transform: translateY(-2px);
        }
        
        .device-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .device-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease;
            font-size: 0.85em;
        }
        
        .device-item:hover {
            transform: translateX(3px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .device-info {
            flex: 1;
        }
        
        .device-name {
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
        }
        
        .device-specs {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.2s ease;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        .quick-actions {
            padding: 15px 20px;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .quick-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s ease;
        }
        
        .quick-btn:hover {
            background: #5a6fd8;
        }
        
        .results {
            grid-column: span 2;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 25px;
        }
        
        .results h2 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .pdf-download {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin: 0 auto 15px auto;
            display: block;
            transition: transform 0.2s ease;
        }
        
        .pdf-download:hover {
            transform: translateY(-2px);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .result-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .result-card:hover {
            transform: translateY(-2px);
        }
        
        .result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .result-value {
            font-size: 1.3em;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .result-details {
            font-size: 0.75em;
            color: #666;
        }
        
        /* Modal Styles - keeping original modal code */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 25px;
            border: none;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
            position: relative;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        .modal-header h2 {
            color: #333;
            font-size: 1.5em;
            margin: 0;
        }
        
        .close {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            transition: color 0.2s ease;
        }
        
        .close:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
            width: auto;
            display: inline-block;
        }
        
        .location-info, .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .info-box {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .chart-container {
            margin-top: 15px;
            height: 200px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #ddd;
        }
        
        .generation-curve {
            width: 100%;
            height: 150px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        /* Dark mode styles */
        body.dark-mode {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        
        .dark-mode .container {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .dark-mode .system-diagram,
        .dark-mode .device-panel,
        .dark-mode .right-panel {
            background: #2d2d2d;
            border-color: #404040;
        }
        
        .dark-mode .left-panel {
            border-color: #404040;
        }
        
        .dark-mode .diagram-title,
        .dark-mode .device-panel h2 {
            color: #e0e0e0;
        }
        
        .dark-mode .component-icon {
            background: #3d3d3d;
            border-color: #667eea;
            color: #e0e0e0;
        }
        
        .dark-mode .component-icon .label {
            color: #e0e0e0;
        }
        
        .dark-mode .device-item {
            background: #3d3d3d;
            border-color: #555;
        }
        
        .dark-mode .device-name {
            color: #e0e0e0;
        }
        
        .dark-mode .device-specs {
            color: #b0b0b0;
        }
        
        .dark-mode .result-card,
        .dark-mode .modal-content,
        .dark-mode .quick-actions {
            background: #3d3d3d;
            color: #e0e0e0;
        }
        
        .dark-mode .result-title {
            color: #e0e0e0;
        }
        
        .dark-mode label {
            color: #c0c0c0;
        }
        
        .dark-mode input,
        .dark-mode select {
            background: #4d4d4d;
            border-color: #555;
            color: #e0e0e0;
        }
        
        .dark-mode input:focus,
        .dark-mode select:focus {
            border-color: #667eea;
            background: #5d5d5d;
        }
        
        .dark-mode .location-info {
            background: #2d4a5a;
            border-color: #4a90e2;
            color: #e0e0e0;
        }
        
        .dark-mode .info-box {
            background: #4a4a2d;
            border-color: #7a7a4a;
            color: #e0e0e0;
        }
        
        .dark-mode .chart-container {
            background: #3d3d3d;
            border-color: #555;
        }
        
        .dark-mode .status-info {
            background: #2d4a5a;
            color: #4fc3f7;
        }
        
        .modal-footer {
            position: sticky;
            bottom: 0;
            background: inherit;
            padding-top: 15px;
            margin-top: 25px;
            border-top: 1px solid #eee;
            text-align: right;
        }
        
        .modal-body {
            max-height: calc(90vh - 150px);
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .modal-body::-webkit-scrollbar {
            width: 6px;
        }
        
        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .modal-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .left-panel {
                border-right: none;
                border-bottom: 2px solid #e9ecef;
            }
            
            .diagram-flow {
                gap: 10px;
            }
            
            .component-icon {
                min-width: 70px;
                min-height: 70px;
                padding: 10px;
            }
            
            .component-icon .icon {
                font-size: 1.8em;
            }
        }
        
        @media (max-width: 768px) {
            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
            
            .diagram-flow {
                flex-direction: column;
                align-items: center;
            }
            
            .flow-arrow {
                transform: rotate(90deg);
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
            <div class="header-content">
                <h1>‚ö° Advanced Solar Calculator</h1>
                <p>Professional solar system design with beautiful interface</p>
            </div>
            <div style="width: 45px;"></div> <!-- Spacer for centering -->
        </div>
        
        <div class="main-layout">
            <div class="left-panel">
                <div class="system-diagram">
                    <h2 class="diagram-title">Solar System Components</h2>
                    
                    <div class="diagram-flow">
                        <div class="component-icon" onclick="openModal('solarModal')" title="Configure sun hours and location">
                            <div class="icon">‚òÄÔ∏è</div>
                            <div class="label">Sun</div>
                        </div>
                        
                        <div class="flow-arrow">‚Üí</div>
                        
                        <div class="component-icon" onclick="openModal('solarModal')" title="Configure solar panels">
                            <div class="icon">‚ö°</div>
                            <div class="label">Panel</div>
                        </div>
                        
                        <div class="flow-arrow">‚Üí</div>
                        
                        <div class="component-icon" onclick="openModal('systemModal')" title="Configure charge controller">
                            <div class="icon">‚öôÔ∏è</div>
                            <div class="label">Controller</div>
                        </div>
                        
                        <div class="flow-arrow">‚Üí</div>
                        
                        <div class="component-icon" onclick="openModal('systemModal')" title="Configure inverter">
                            <div class="icon">üîå</div>
                            <div class="label">Inverter</div>
                        </div>
                        
                        <div class="flow-arrow">‚Üí</div>
                        
                        <div class="component-icon" onclick="openModal('deviceModal')" title="Add electrical devices">
                            <div class="icon">üè†</div>
                            <div class="label">Load</div>
                        </div>
                    </div>
                    
                    <div class="battery-section">
                        <div class="component-icon" onclick="openModal('systemModal')" title="Configure battery bank">
                            <div class="icon">üîã</div>
                            <div class="label">Battery</div>
                        </div>
                    </div>
                    
                    <div class="status-info" id="systemStatus">
                        Click components above to configure your solar system
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="device-panel">
                    <h2>üìã Device List</h2>
                    <button class="add-device-btn" onclick="openModal('deviceModal')">
                        ‚ûï Add Device
                    </button>
                    <div class="device-list" id="deviceList">
                        <p style="text-align: center; color: #666; padding: 20px; font-size: 0.85em;">
                            No devices added yet
                        </p>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="quick-btn" onclick="openModal('solarModal')">üåç Location & Sun</button>
                    <button class="quick-btn" onclick="openModal('systemModal')">‚öôÔ∏è System Config</button>
                    <button class="quick-btn" onclick="clearAllDevices()">üóëÔ∏è Clear All</button>
                </div>
            </div>
        </div>
        
        <div class="results">
            <h2>üìä System Analysis</h2>
            <button class="pdf-download" onclick="generatePDF()">üìÑ Download PDF Report</button>
            <div class="results-grid" id="results">
                <p style="text-align: center; color: #666; padding: 20px; grid-column: 1/-1;">
                    Configure your system components to see the analysis
                </p>
            </div>
        </div>
    </div>

    <!-- Solar & Location Modal -->
    <div id="solarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üåç Location & Solar Configuration</h2>
                <span class="close" onclick="closeModal('solarModal')">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label>Your Location</label>
                    <input type="text" id="location" placeholder="Enter city or coordinates">
                    <button onclick="getLocation()" class="btn btn-small">üìç Use My Location</button>
                </div>
                
                <div id="locationInfo" class="location-info" style="display:none;"></div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Daily Sun Hours</label>
                        <input type="number" id="sunHours" value="5" min="1" max="12" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Autonomy Period</label>
                        <select id="autonomyUnit">
                            <option value="days">Days</option>
                            <option value="hours">Hours</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Autonomy Duration</label>
                    <input type="number" id="autonomyValue" value="2" min="0.5" step="0.5">
                </div>
                
                <div class="form-group">
                    <label>Power Generation Pattern</label>
                    <select id="generationPattern">
                        <option value="linear">Linear (Equal throughout day)</option>
                        <option value="gaussian">Gaussian (Peak at midday)</option>
                        <option value="custom">Custom Distribution</option>
                    </select>
                </div>
                
                <div id="generationChart" class="chart-container" style="display:none;">
                    <canvas id="generationCurve" class="generation-curve"></canvas>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('solarModal')">Close</button>
                <button class="btn" onclick="saveSolarConfig()">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- System Configuration Modal -->
    <div id="systemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è System Configuration</h2>
                <span class="close" onclick="closeModal('systemModal')">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>DC System Voltage</label>
                        <select id="systemVoltage">
                            <option value="12">12V DC</option>
                            <option value="24" selected>24V DC</option>
                            <option value="36">36V DC</option>
                            <option value="48">48V DC</option>
                            <option value="60">60V DC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Inverter Output Voltage</label>
                        <select id="inverterVoltage">
                            <option value="110">110V AC</option>
                            <option value="240" selected>240V AC</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>System Efficiency (%)</label>
                        <input type="number" id="systemEfficiency" value="80" min="50" max="95">
                    </div>
                    <div class="form-group">
                        <label>Battery DOD (%)</label>
                        <input type="number" id="batteryDOD" value="50" min="20" max="90">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Panel Derating (%)</label>
                        <input type="number" id="panelDerating" value="80" min="50" max="95">
                    </div>
                    <div class="form-group">
                        <label>Safety Margin (%)</label>
                        <input type="number" id="safetyMargin" value="25" min="10" max="50">
                    </div>
                </div>
                
                <div class="info-box">
                    üí° <strong>DOD (Depth of Discharge):</strong> Percentage of battery capacity you can safely use. 
                    Lower DOD = longer battery life. Lead-acid: 50%, Lithium: 80-90%.
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('systemModal')">Close</button>
                <button class="btn" onclick="saveSystemConfig()">Save Configuration</button>
            </div>
        </div>
    </div>

    <!-- Device Configuration Modal -->
    <div id="deviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîå Add Device</h2>
                <span class="close" onclick="closeModal('deviceModal')">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label>Device Type</label>
                    <select id="deviceType">
                        <option value="laptop">Laptop</option>
                        <option value="tv">TV</option>
                        <option value="fan">Fan</option>
                        <option value="refrigerator">Refrigerator</option>
                        <option value="led_bulb">LED Bulb</option>
                        <option value="cfl_bulb">CFL Bulb</option>
                        <option value="microwave">Microwave</option>
                        <option value="washing_machine">Washing Machine</option>
                        <option value="custom">Custom Device</option>
                    </select>
                </div>
                
                <div class="form-group" id="customNameGroup" style="display:none;">
                    <label>Device Name</label>
                    <input type="text" id="customName" placeholder="Enter device name">
                </div>
                
                <div class="form-group">
                    <label>Power Input Method</label>
                    <select id="powerMethod">
                        <option value="wattage">Wattage & Efficiency</option>
                        <option value="voltage_current">Voltage & Current</option>
                    </select>
                </div>
                
                <div id="wattageInputs">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Wattage (W)</label>
                            <input type="number" id="wattage" min="1">
                        </div>
                        <div class="form-group">
                            <label>Efficiency (%) - Optional</label>
                            <input type="number" id="efficiency" placeholder="Default: 90%">
                        </div>
                    </div>
                </div>
                
                <div id="voltageCurrentInputs" style="display:none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Voltage (V)</label>
                            <select id="deviceVoltage">
                                <option value="110">110V AC</option>
                                <option value="240">240V AC</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Current (A)</label>
                            <input type="number" id="current" min="0.1" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="quantity" value="1" min="1">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Daytime Hours (Sunny)</label>
                        <input type="number" id="daytimeHours" value="0" min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Nighttime Hours (Battery)</label>
                        <input type="number" id="nighttimeHours" value="1" min="0" step="0.1">
                    </div>
                </div>
                
                <div class="info-box">
                    üí° <strong>Tip:</strong> Daytime hours reduce battery drain as panels supply power directly. 
                    Nighttime hours determine battery capacity needed.
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('deviceModal')">Close</button>
                <button class="btn" onclick="addDevice()">Add Device</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let devices = [];
        let systemVoltageFixed = false;
        let generationChart = null;
        let isDarkMode = false;
        
        const presetDevices = {
            laptop: { wattage: 65, efficiency: 90 },
            tv: { wattage: 150, efficiency: 85 },
            fan: { wattage: 75, efficiency: 80 },
            refrigerator: { wattage: 200, efficiency: 70 },
            led_bulb: { wattage: 10, efficiency: 90 },
            cfl_bulb: { wattage: 23, efficiency: 80 },
            microwave: { wattage: 1000, efficiency: 75 },
            washing_machine: { wattage: 500, efficiency: 80 }
        };
        
        // Solar data for major cities (average annual values)
        const solarData = {
            'colombo': { sunHours: 5.8, lat: 6.9271, lon: 79.8612, country: 'Sri Lanka' },
            'kandy': { sunHours: 5.5, lat: 7.2906, lon: 80.6337, country: 'Sri Lanka' },
            'galle': { sunHours: 6.2, lat: 6.0535, lon: 80.2210, country: 'Sri Lanka' },
            'new york': { sunHours: 4.2, lat: 40.7128, lon: -74.0060, country: 'USA' },
            'los angeles': { sunHours: 6.8, lat: 34.0522, lon: -118.2437, country: 'USA' },
            'london': { sunHours: 2.8, lat: 51.5074, lon: -0.1278, country: 'UK' },
            'berlin': { sunHours: 3.1, lat: 52.5200, lon: 13.4050, country: 'Germany' },
            'tokyo': { sunHours: 3.9, lat: 35.6762, lon: 139.6503, country: 'Japan' },
            'sydney': { sunHours: 5.3, lat: -33.8688, lon: 151.2093, country: 'Australia' },
            'cairo': { sunHours: 7.1, lat: 30.0444, lon: 31.2357, country: 'Egypt' },
            'mumbai': { sunHours: 5.6, lat: 19.0760, lon: 72.8777, country: 'India' },
            'delhi': { sunHours: 5.8, lat: 28.7041, lon: 77.1025, country: 'India' }
        };
        
        // Initialize with laptop preset and check for saved theme
        window.onload = function() {
            const preset = presetDevices.laptop;
            document.getElementById('wattage').value = preset.wattage;
            document.getElementById('efficiency').value = preset.efficiency;
            
            // Load saved theme
            const savedTheme = localStorage.getItem('solarCalcTheme');
            if (savedTheme === 'dark') {
                toggleTheme();
            }
            
            // Update component status
            updateSystemStatus();
        };
        
        // Event listeners
        document.getElementById('deviceType').addEventListener('change', function() {
            const customGroup = document.getElementById('customNameGroup');
            const wattageInput = document.getElementById('wattage');
            const efficiencyInput = document.getElementById('efficiency');
            
            if (this.value === 'custom') {
                customGroup.style.display = 'block';
                wattageInput.value = '';
                efficiencyInput.value = '';
            } else {
                customGroup.style.display = 'none';
                const preset = presetDevices[this.value];
                wattageInput.value = preset.wattage;
                efficiencyInput.value = preset.efficiency;
            }
        });
        
        document.getElementById('powerMethod').addEventListener('change', function() {
            const wattageInputs = document.getElementById('wattageInputs');
            const voltageCurrentInputs = document.getElementById('voltageCurrentInputs');
            
            if (this.value === 'wattage') {
                wattageInputs.style.display = 'block';
                voltageCurrentInputs.style.display = 'none';
            } else {
                wattageInputs.style.display = 'none';
                voltageCurrentInputs.style.display = 'block';
            }
        });
        
        document.getElementById('generationPattern').addEventListener('change', function() {
            const chartContainer = document.getElementById('generationChart');
            if (this.value === 'gaussian' || this.value === 'custom') {
                chartContainer.style.display = 'block';
                drawGenerationCurve();
            } else {
                chartContainer.style.display = 'none';
            }
        });
        
        document.getElementById('location').addEventListener('input', function() {
            const location = this.value.toLowerCase().trim();
            if (solarData[location]) {
                updateLocationInfo(solarData[location], location);
            }
        });
        
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            
            const themeButton = document.querySelector('.theme-toggle');
            if (isDarkMode) {
                themeButton.textContent = '‚òÄÔ∏è';
                localStorage.setItem('solarCalcTheme', 'dark');
            } else {
                themeButton.textContent = 'üåô';
                localStorage.setItem('solarCalcTheme', 'light');
            }
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function updateSystemStatus() {
            const sunHours = document.getElementById('sunHours').value;
            const location = document.getElementById('location').value;
            const systemVoltage = document.getElementById('systemVoltage').value;
            const deviceCount = devices.length;
            
            let statusText = `${systemVoltage}V DC system, ${sunHours}h sun/day`;
            if (location) {
                statusText += ` at ${location}`;
            }
            if (deviceCount > 0) {
                statusText += ` | ${deviceCount} device${deviceCount > 1 ? 's' : ''} added`;
            }
            
            document.getElementById('systemStatus').textContent = statusText;
        }
        
        function saveSolarConfig() {
            updateSystemStatus();
            calculateSystem();
            closeModal('solarModal');
        }
        
        function saveSystemConfig() {
            updateSystemStatus();
            calculateSystem();
            closeModal('systemModal');
        }
        
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Estimate sun hours based on latitude (simplified)
                    let estimatedSunHours = 6 - Math.abs(lat) * 0.05;
                    estimatedSunHours = Math.max(2, Math.min(8, estimatedSunHours));
                    
                    document.getElementById('sunHours').value = estimatedSunHours.toFixed(1);
                    document.getElementById('location').value = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    
                    const locationInfo = document.getElementById('locationInfo');
                    locationInfo.innerHTML = `üìç Location detected: ${lat.toFixed(4)}, ${lon.toFixed(4)}<br>üåû Estimated sun hours: ${estimatedSunHours.toFixed(1)}`;
                    locationInfo.style.display = 'block';
                }, function(error) {
                    alert('Unable to get location: ' + error.message);
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }
        
        function updateLocationInfo(data, location) {
            document.getElementById('sunHours').value = data.sunHours;
            const locationInfo = document.getElementById('locationInfo');
            locationInfo.innerHTML = `üåç Location: ${location.charAt(0).toUpperCase() + location.slice(1)}, ${data.country}<br>üåû Average sun hours: ${data.sunHours} hours/day`;
            locationInfo.style.display = 'block';
        }
        
        function drawGenerationCurve() {
            const canvas = document.getElementById('generationCurve');
            const ctx = canvas.getContext('2d');
            const sunHours = parseFloat(document.getElementById('sunHours').value);
            const pattern = document.getElementById('generationPattern').value;
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw axes
            ctx.strokeStyle = '#ccc';
            ctx.beginPath();
            ctx.moveTo(40, 20);
            ctx.lineTo(40, canvas.height - 40);
            ctx.lineTo(canvas.width - 20, canvas.height - 40);
            ctx.stroke();
            
            // Draw curve
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            const points = 100;
            for (let i = 0; i <= points; i++) {
                const x = 40 + (canvas.width - 60) * i / points;
                const hour = 24 * i / points;
                let y;
                
                if (pattern === 'gaussian') {
                    // Gaussian distribution centered at noon
                    const center = 12;
                    const sigma = sunHours / 4;
                    const gaussian = Math.exp(-0.5 * Math.pow((hour - center) / sigma, 2));
                    y = canvas.height - 40 - (canvas.height - 80) * gaussian;
                } else {
                    // Linear for comparison
                    if (hour >= 6 && hour <= 18) {
                        y = canvas.height - 40 - (canvas.height - 80) * 0.8;
                    } else {
                        y = canvas.height - 40;
                    }
                }
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.fillText('6AM', 40, canvas.height - 25);
            ctx.fillText('12PM', canvas.width/2 - 15, canvas.height - 25);
            ctx.fillText('6PM', canvas.width - 60, canvas.height - 25);
            ctx.fillText('100%', 5, 30);
            ctx.fillText('0%', 15, canvas.height - 45);
        }
        
        function addDevice() {
            const deviceType = document.getElementById('deviceType').value;
            const powerMethod = document.getElementById('powerMethod').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const daytimeHours = parseFloat(document.getElementById('daytimeHours').value);
            const nighttimeHours = parseFloat(document.getElementById('nighttimeHours').value);
            
            let deviceName, wattage, efficiency, voltage, current;
            
            if (deviceType === 'custom') {
                deviceName = document.getElementById('customName').value;
                if (!deviceName.trim()) {
                    alert('Please enter a device name for custom device');
                    return;
                }
            } else {
                deviceName = deviceType.replace('_', ' ').toUpperCase();
            }
            
            if (powerMethod === 'wattage') {
                wattage = parseFloat(document.getElementById('wattage').value);
                efficiency = parseFloat(document.getElementById('efficiency').value) || 90;
                
                if (!wattage || wattage <= 0) {
                    alert('Please enter a valid wattage');
                    return;
                }
            } else {
                voltage = parseFloat(document.getElementById('deviceVoltage').value);
                current = parseFloat(document.getElementById('current').value);
                
                if (!current || current <= 0) {
                    alert('Please enter a valid current');
                    return;
                }
                
                wattage = voltage * current;
                efficiency = 90;
                
                if (!systemVoltageFixed) {
                    document.getElementById('inverterVoltage').value = voltage;
                    document.getElementById('inverterVoltage').disabled = true;
                    systemVoltageFixed = true;
                }
            }
            
            const device = {
                name: deviceName,
                wattage: wattage,
                efficiency: efficiency,
                quantity: quantity,
                daytimeHours: daytimeHours,
                nighttimeHours: nighttimeHours,
                powerMethod: powerMethod,
                voltage: powerMethod === 'voltage_current' ? voltage : null,
                current: powerMethod === 'voltage_current' ? current : null
            };
            
            devices.push(device);
            updateDeviceList();
            updateSystemStatus();
            calculateSystem();
            closeModal('deviceModal');
            
            // Reset form
            if (deviceType === 'custom') {
                document.getElementById('customName').value = '';
            }
            document.getElementById('quantity').value = 1;
            document.getElementById('daytimeHours').value = 0;
            document.getElementById('nighttimeHours').value = 1;
        }
        
        function removeDevice(index) {
            devices.splice(index, 1);
            
            const hasVoltageCurrentDevices = devices.some(d => d.powerMethod === 'voltage_current');
            if (!hasVoltageCurrentDevices) {
                document.getElementById('inverterVoltage').disabled = false;
                systemVoltageFixed = false;
            }
            
            updateDeviceList();
            updateSystemStatus();
            calculateSystem();
        }
        
        function clearAllDevices() {
            if (devices.length === 0) {
                alert('No devices to clear');
                return;
            }
            
            if (confirm('Are you sure you want to remove all devices?')) {
                devices = [];
                document.getElementById('inverterVoltage').disabled = false;
                systemVoltageFixed = false;
                updateDeviceList();
                updateSystemStatus();
                calculateSystem();
            }
        }
        
        function updateDeviceList() {
            const deviceList = document.getElementById('deviceList');
            
            if (devices.length === 0) {
                deviceList.innerHTML = `
                    <p style="text-align: center; color: #666; padding: 20px; font-size: 0.85em;">
                        No devices added yet
                    </p>
                `;
                return;
            }
            
            deviceList.innerHTML = '';
            
            devices.forEach((device, index) => {
                const deviceDiv = document.createElement('div');
                deviceDiv.className = 'device-item';
                
                let specs = `${device.wattage}W`;
                if (device.powerMethod === 'voltage_current') {
                    specs += ` (${device.voltage}V √ó ${device.current}A)`;
                }
                specs += ` | ${device.quantity}√ó qty`;
                specs += `<br>Day: ${device.daytimeHours}h, Night: ${device.nighttimeHours}h`;
                
                deviceDiv.innerHTML = `
                    <div class="device-info">
                        <div class="device-name">${device.name}</div>
                        <div class="device-specs">${specs}</div>
                    </div>
                    <button class="remove-btn" onclick="removeDevice(${index})">√ó</button>
                `;
                
                deviceList.appendChild(deviceDiv);
            });
        }
        
        function calculateSystem() {
            if (devices.length === 0) {
                document.getElementById('results').innerHTML = `
                    <p style="text-align: center; color: #666; padding: 20px; grid-column: 1/-1;">
                        Add devices to see the system analysis
                    </p>
                `;
                return;
            }
            
            const systemVoltage = parseFloat(document.getElementById('systemVoltage').value);
            const sunHours = parseFloat(document.getElementById('sunHours').value);
            const autonomyUnit = document.getElementById('autonomyUnit').value;
            const autonomyValue = parseFloat(document.getElementById('autonomyValue').value);
            const autonomyHours = autonomyUnit === 'days' ? autonomyValue * 24 : autonomyValue;
            const systemEfficiency = parseFloat(document.getElementById('systemEfficiency').value) / 100;
            const batteryDOD = parseFloat(document.getElementById('batteryDOD').value) / 100;
            const panelDerating = parseFloat(document.getElementById('panelDerating').value) / 100;
            const safetyMargin = parseFloat(document.getElementById('safetyMargin').value) / 100;
            const generationPattern = document.getElementById('generationPattern').value;
            
            // Calculate energy consumption
            let totalDaytimeWh = 0;
            let totalNighttimeWh = 0;
            let totalPeakWatts = 0;
            
            devices.forEach(device => {
                const actualWattage = device.wattage / (device.efficiency / 100);
                const daytimeWh = actualWattage * device.quantity * device.daytimeHours;
                const nighttimeWh = actualWattage * device.quantity * device.nighttimeHours;
                
                totalDaytimeWh += daytimeWh;
                totalNighttimeWh += nighttimeWh;
                totalPeakWatts += actualWattage * device.quantity;
            });
            
            const totalDailyWh = totalDaytimeWh + totalNighttimeWh;
            
            // Advanced generation calculation based on pattern
            let effectiveGenerationHours = sunHours;
            if (generationPattern === 'gaussian') {
                effectiveGenerationHours = sunHours * 1.15;
            }
            
            // Net energy that needs to come from battery (nighttime + deficit)
            const netBatteryWh = totalNighttimeWh + Math.max(0, totalDaytimeWh - (effectiveGenerationHours * 100));
            
            // Solar panel calculations
            const totalDailyWhWithLosses = totalDailyWh / systemEfficiency;
            const solarWattsNeeded = totalDailyWhWithLosses / effectiveGenerationHours / panelDerating;
            const recommendedSolarWatts = solarWattsNeeded * (1 + safetyMargin);
            
            // Advanced battery calculations
            const batteryWhNeeded = (netBatteryWh * autonomyHours / 24) / batteryDOD;
            const batteryAhNeeded = batteryWhNeeded / systemVoltage;
            
            // Inverter requirements
            const inverterWattsNeeded = totalPeakWatts * (1 + safetyMargin);
            
            // Charge controller requirements
            const chargeControllerAmps = recommendedSolarWatts / systemVoltage * (1 + safetyMargin * 0.5);
            
            // Generation efficiency factor
            let generationEfficiency = 1.0;
            if (generationPattern === 'gaussian') {
                generationEfficiency = 1.15;
            }
            
            displayResults({
                totalDailyWh: totalDailyWh.toFixed(0),
                totalDaytimeWh: totalDaytimeWh.toFixed(0),
                totalNighttimeWh: totalNighttimeWh.toFixed(0),
                totalDailyWhWithLosses: totalDailyWhWithLosses.toFixed(0),
                totalPeakWatts: totalPeakWatts.toFixed(0),
                solarWattsNeeded: solarWattsNeeded.toFixed(0),
                recommendedSolarWatts: recommendedSolarWatts.toFixed(0),
                batteryWhNeeded: batteryWhNeeded.toFixed(0),
                batteryAhNeeded: batteryAhNeeded.toFixed(0),
                inverterWattsNeeded: inverterWattsNeeded.toFixed(0),
                chargeControllerAmps: chargeControllerAmps.toFixed(1),
                systemVoltage: systemVoltage,
                autonomyHours: autonomyHours.toFixed(1),
                generationPattern: generationPattern,
                generationEfficiency: generationEfficiency,
                effectiveGenerationHours: effectiveGenerationHours.toFixed(1)
            });
        }
        
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = `
                <div class="result-card">
                    <div class="result-title">Daily Energy</div>
                    <div class="result-value">${results.totalDailyWh} Wh</div>
                    <div class="result-details">Day: ${results.totalDaytimeWh} Wh<br>Night: ${results.totalNighttimeWh} Wh</div>
                </div>
                
                <div class="result-card">
                    <div class="result-title">Peak Power</div>
                    <div class="result-value">${results.totalPeakWatts} W</div>
                    <div class="result-details">Maximum load</div>
                </div>
                
                <div class="result-card">
                    <div class="result-title">Solar Panels</div>
                    <div class="result-value">${results.recommendedSolarWatts} W</div>
                    <div class="result-details">Min: ${results.solarWattsNeeded} W<br>Gen: ${results.effectiveGenerationHours}h</div>
                </div>
                
                <div class="result-card">
                    <div class="result-title">Battery Bank</div>
                    <div class="result-value">${results.batteryAhNeeded} Ah</div>
                    <div class="result-details">At ${results.systemVoltage}V<br>(${results.batteryWhNeeded} Wh)</div>
                </div>
                
                <div class="result-card">
                    <div class="result-title">Inverter</div>
                    <div class="result-value">${results.inverterWattsNeeded} W</div>
                    <div class="result-details">With safety margin</div>
                </div>
                
                <div class="result-card">
                    <div class="result-title">Controller</div>
                    <div class="result-value">${results.chargeControllerAmps} A</div>
                    <div class="result-details">MPPT recommended</div>
                </div>
            `;
        }
        
        function generatePDF() {
            if (devices.length === 0) {
                alert('Please add some devices before generating the PDF report.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get current system data
            const systemVoltage = parseFloat(document.getElementById('systemVoltage').value);
            const sunHours = parseFloat(document.getElementById('sunHours').value);
            const autonomyUnit = document.getElementById('autonomyUnit').value;
            const autonomyValue = parseFloat(document.getElementById('autonomyValue').value);
            const location = document.getElementById('location').value || 'Not specified';
            const generationPattern = document.getElementById('generationPattern').value;
            
            // Calculate totals for PDF
            let totalDailyWh = 0;
            let totalDaytimeWh = 0;
            let totalNighttimeWh = 0;
            let totalPeakWatts = 0;
            
            devices.forEach(device => {
                const actualWattage = device.wattage / (device.efficiency / 100);
                totalDaytimeWh += actualWattage * device.quantity * device.daytimeHours;
                totalNighttimeWh += actualWattage * device.quantity * device.nighttimeHours;
                totalPeakWatts += actualWattage * device.quantity;
            });
            totalDailyWh = totalDaytimeWh + totalNighttimeWh;
            
            // Calculate system requirements
            const systemEfficiency = parseFloat(document.getElementById('systemEfficiency').value) / 100;
            const batteryDOD = parseFloat(document.getElementById('batteryDOD').value) / 100;
            const panelDerating = parseFloat(document.getElementById('panelDerating').value) / 100;
            const safetyMargin = parseFloat(document.getElementById('safetyMargin').value) / 100;
            
            let effectiveGenerationHours = sunHours;
            if (generationPattern === 'gaussian') {
                effectiveGenerationHours = sunHours * 1.15;
            }
            
            const totalDailyWhWithLosses = totalDailyWh / systemEfficiency;
            const solarWattsNeeded = totalDailyWhWithLosses / effectiveGenerationHours / panelDerating;
            const recommendedSolarWatts = solarWattsNeeded * (1 + safetyMargin);
            const autonomyHours = autonomyUnit === 'days' ? autonomyValue * 24 : autonomyValue;
            const netBatteryWh = totalNighttimeWh + Math.max(0, totalDaytimeWh - (effectiveGenerationHours * 100));
            const batteryWhNeeded = (netBatteryWh * autonomyHours / 24) / batteryDOD;
            const batteryAhNeeded = batteryWhNeeded / systemVoltage;
            const inverterWattsNeeded = totalPeakWatts * (1 + safetyMargin);
            const chargeControllerAmps = recommendedSolarWatts / systemVoltage * (1 + safetyMargin * 0.5);
            
            // PDF Header
            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234);
            doc.text('Off-Grid Solar System Design Report', 20, 30);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 40);
            doc.text(`Location: ${location}`, 20, 50);
            
            // System Overview
            let yPos = 70;
            doc.setFontSize(16);
            doc.setTextColor(102, 126, 234);
            doc.text('System Overview', 20, yPos);
            yPos += 15;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text(`DC System Voltage: ${systemVoltage}V`, 20, yPos);
            doc.text(`Daily Sun Hours: ${sunHours}h`, 120, yPos);
            yPos += 10;
            doc.text(`Generation Pattern: ${generationPattern}`, 20, yPos);
            doc.text(`Autonomy: ${autonomyValue} ${autonomyUnit}`, 120, yPos);
            yPos += 20;
            
            // Device List
            doc.setFontSize(16);
            doc.setTextColor(102, 126, 234);
            doc.text('Device List', 20, yPos);
            yPos += 15;
            
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            devices.forEach((device, index) => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 30;
                }
                
                const actualWattage = device.wattage / (device.efficiency / 100);
                doc.text(`${index + 1}. ${device.name}`, 20, yPos);
                yPos += 8;
                doc.text(`   Power: ${device.wattage}W (${actualWattage.toFixed(1)}W actual) | Qty: ${device.quantity} | Efficiency: ${device.efficiency}%`, 25, yPos);
                yPos += 8;
                doc.text(`   Usage: ${device.daytimeHours}h daytime, ${device.nighttimeHours}h nighttime`, 25, yPos);
                yPos += 12;
            });
            
            // Energy Consumption Analysis
            yPos += 10;
            if (yPos > 220) {
                doc.addPage();
                yPos = 30;
            }
            
            doc.setFontSize(16);
            doc.setTextColor(102, 126, 234);
            doc.text('Energy Consumption Analysis', 20, yPos);
            yPos += 15;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text(`Total Daily Consumption: ${totalDailyWh.toFixed(0)} Wh`, 20, yPos);
            yPos += 10;
            doc.text(`  - Daytime Consumption: ${totalDaytimeWh.toFixed(0)} Wh`, 25, yPos);
            yPos += 8;
            doc.text(`  - Nighttime Consumption: ${totalNighttimeWh.toFixed(0)} Wh`, 25, yPos);
            yPos += 10;
            doc.text(`Total with System Losses: ${totalDailyWhWithLosses.toFixed(0)} Wh`, 20, yPos);
            yPos += 10;
            doc.text(`Peak Power Demand: ${totalPeakWatts.toFixed(0)} W`, 20, yPos);
            yPos += 20;
            
            // System Requirements
            doc.setFontSize(16);
            doc.setTextColor(102, 126, 234);
            doc.text('Recommended System Components', 20, yPos);
            yPos += 15;
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            
            // Solar Panels
            doc.setFontSize(14);
            doc.text('1. Solar Panels', 20, yPos);
            yPos += 10;
            doc.setFontSize(11);
            doc.text(`Recommended Capacity: ${recommendedSolarWatts.toFixed(0)} W`, 25, yPos);
            yPos += 8;
            doc.text(`Minimum Required: ${solarWattsNeeded.toFixed(0)} W`, 25, yPos);
            yPos += 8;
            doc.text(`Effective Generation Hours: ${effectiveGenerationHours.toFixed(1)} h/day`, 25, yPos);
            yPos += 15;
            
            // Battery Bank
            doc.setFontSize(14);
            doc.text('2. Battery Bank', 20, yPos);
            yPos += 10;
            doc.setFontSize(11);
            doc.text(`Capacity Required: ${batteryAhNeeded.toFixed(0)} Ah at ${systemVoltage}V`, 25, yPos);
            yPos += 8;
            doc.text(`Energy Storage: ${batteryWhNeeded.toFixed(0)} Wh`, 25, yPos);
            yPos += 8;
            doc.text(`Depth of Discharge: ${(parseFloat(document.getElementById('batteryDOD').value))}%`, 25, yPos);
            yPos += 15;
            
            // Inverter
            doc.setFontSize(14);
            doc.text('3. Inverter', 20, yPos);
            yPos += 10;
            doc.setFontSize(11);
            doc.text(`Minimum Capacity: ${inverterWattsNeeded.toFixed(0)} W`, 25, yPos);
            yPos += 8;
            doc.text(`Output Voltage: ${document.getElementById('inverterVoltage').value}V AC`, 25, yPos);
            yPos += 15;
            
            // Charge Controller
            doc.setFontSize(14);
            doc.text('4. Charge Controller', 20, yPos);
            yPos += 10;
            doc.setFontSize(11);
            doc.text(`Current Rating: ${chargeControllerAmps.toFixed(1)} A`, 25, yPos);
            yPos += 8;
            doc.text(`Type: MPPT Recommended`, 25, yPos);
            yPos += 8;
            doc.text(`System Voltage: ${systemVoltage}V DC`, 25, yPos);
            
            // Add new page for additional information
            doc.addPage();
            yPos = 30;
            
            // Installation Notes
            doc.setFontSize(16);
            doc.setTextColor(102, 126, 234);
            doc.text('Installation & Safety Notes', 20, yPos);
            yPos += 15;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            const notes = [
                '‚Ä¢ All calculations include safety margins for reliable operation',
                '‚Ä¢ Battery capacity assumes specified depth of discharge limits',
                '‚Ä¢ Solar panel sizing accounts for real-world derating factors',
                '‚Ä¢ Professional installation is recommended for safety and optimal performance',
                '‚Ä¢ Regular maintenance will ensure maximum system lifespan',
                '‚Ä¢ Consider local electrical codes and permit requirements',
                '‚Ä¢ Battery ventilation and temperature control are essential',
                '‚Ä¢ Install proper fusing and disconnects for safety'
            ];
            
            notes.forEach(note => {
                doc.text(note, 20, yPos);
                yPos += 10;
            });
            
            // Footer
            yPos += 20;
            doc.setFontSize(10);
            doc.setTextColor(128, 128, 128);
            doc.text('Generated by Advanced Off-Grid Solar Calculator', 20, yPos);
            doc.text('This report is for planning purposes. Consult with professionals for final installation.', 20, yPos + 10);
            
            // Save the PDF
            const fileName = `Solar_System_Design_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = ['solarModal', 'systemModal', 'deviceModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeModal(modalId);
                }
            });
        }
        
        // Update calculations when system parameters change
        const parameterIds = ['systemVoltage', 'sunHours', 'autonomyValue', 'autonomyUnit', 'systemEfficiency', 'batteryDOD', 'panelDerating', 'safetyMargin'];
        parameterIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', calculateSystem);
            }
        });
    </script>
</body>
</html></option